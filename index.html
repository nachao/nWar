<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>nWar</title>
		<style>

			body{ font-family: 'Segoe UI Light','Segoe UI','Microsoft Jhenghei','微软雅黑',sans-serif; }

			/* 宫格 */
			.swipepad{
				margin: 0 auto;
				position: relative;
			}
			.swipepad-item{
				width: 50%;
				height: 50%;
				margin: 25% 0 0 25%;
				background-color: #eee;
				border-radius: 3px;
				position: relative;
			}
			.swipepad-item:hover{
				background-color: #ddd;
			}
			.swipepad .swipepad-temp{
				/*background-color: #eee;*/
				position: absolute;
			}
			.swipepad .swipepad-temp:hover{
				/*background-color: #ddd;*/
			}
			.swipepad .swipepad-template{
				display: none;
			}
			.swipepad-contain{
				display: none;
				width: 100%;
				height: 100%;
				position: relative;
			}
			.swipepad-owner{
				display: inline-block;
				line-height: 24px;
				transform: rotate(270deg);
				transform-origin: top left;
				position: absolute;
				top: 100%;
				left: -24px;
				width: 100%;
				white-space: nowrap;
				text-overflow: ellipsis;
				overflow: hidden;
				text-align: right;
				font-size: 12px;
			}
			.swipepad-text{
				display: none;
				text-align: center;
				line-height: 50px;
				margin: 0 50px;
				position: relative;
			}
			.swipepad-name{
				text-decoration: none;
				color: black;
				font-size: 20px;
			}
			.swipepad-up{
				text-decoration: none;
				display: inline-block;
				position: absolute;
				right: 0px;
				opacity: 0.4;
			}
			.swipepad-up span{
				font-size: 24px;
			}
			.swipepad-up:hover{
				opacity: 0.8;
			}
			.swipepad-active .swipepad-contain{
				display: inline-block;
			}
			.swipepad-active .swipepad-text{
				display: block;
			}


			/* 元素功能 */
			.nexpand{
				/*width: 100px;*/
				/*height: 100px;*/
				/*line-height: 100px;*/
				/*margin: 100px;*/
				/*background-color: #aaa;*/
				/*border-radius: 50%;*/
				/*cursor: pointer;*/
				/*color: white;*/
				/*text-align: center;*/
				/*position: relative;*/
			}
			.nexpand-btns {
				width: 50px;
				height: 100px;
				border-radius: 3px;
				display: none;
				float: right;
				margin-right: -50px;
			}

			.nexpand-btn{
				display: inline-block;
				line-height: 18px;
				font-size: 12px;
				border-radius: 3px;
				background-color: #737373;
				text-decoration: none;
				font-style: normal;
				color: white;
				padding: 0 10px;
				float: left;
				margin: 0 0 9px 5px;
				font-family: Arial;
			}
			.nexpand-btn:hover{
				background-color: #666;
			}


			/* 自增 */
			.growups-value{
				width: 100px;
				height: 100px;
				line-height: 100px;
				color: white;
				text-align: center;
				position: absolute;
				z-index: 2;	
				font-size: 33px;
				opacity: 0.7;
			}
			.growups-value:hover{
				opacity: 0.8;
			}

			.growups-act{
				/*background-color: #CF000D;*/
			}



			/* 图标 */
			@font-face {font-family: "iconfont";
			  src: url('font/iconfont.eot'); /* IE9*/
			  src: url('font/iconfont.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
			  url('font/iconfont.woff') format('woff'), /* chrome, firefox */
			  url('font/iconfont.ttf') format('truetype'), /* chrome, firefox, opera, Safari, Android, iOS 4.2+*/
			  url('font/iconfont.svg#iconfont') format('svg'); /* iOS 4.1- */
			}

			.iconfont {
			  font-family:"iconfont" !important;
			  font-size:16px;
			  font-style:normal;
			  -webkit-font-smoothing: antialiased;
			  -webkit-text-stroke-width: 0.2px;
			  -moz-osx-font-smoothing: grayscale;
			}
			.icon-target:before { content: "\e61c"; }
			.icon-shengji:before { content: "\e609"; }
			.icon-target1:before { content: "\f0006"; }


		</style>
	</head>
	<body>

		<div class="swipepad" id="swipepad">
			<div class="swipepad-template" id="swipepad-template">
				<div class="swipepad-item">
					<div class="growups-value"></div>
					<div class="swipepad-contain nexpand-contain">
						<span class="swipepad-owner"></span>
					</div>
				</div>
				<div class="swipepad-text">
					<a class="swipepad-name" href="#">1</a>
					<a class="swipepad-up expand-up" href="#" title="upgrade."><span class="iconfont icon-shengji"></span></a>
				</div>
			</div>
		</div>


		<script src="jquery-1.11.0.min.js" ></script>
		<script src="narray-0.3.min.js" ></script>
		<script src="vue.js" ></script>
		<script src="./lib/4.growup.js" ></script>		<!-- 自增 -->
		<script src="./lib/5.swipepad.js" ></script>	<!-- 宫格 -->
		<script src="./lib/6.expand.js" ></script>		<!-- 元素功能 -->
		<script>



			function nWar () {}

			// 定义方法
			$.extend(nWar, {

				// 引用工具
				lib: {
					swipepad: new nW5(),
					expand: new nW6(),
					growup: new nW4()
				},

				// 全部位置
				places: [],

				// 当前操作的位置
				selected: null,

				// 全部用户
				groups: [
					{
						uid: (new Date().getTime() + parseInt(Math.random() * 360)).toString(36),
						name: 'aaa',
						color: 'red',
						value: 0
					},
					{
						uid: (new Date().getTime() + parseInt(Math.random() * 360)).toString(36),
						name: 'bbb',
						color: 'blue',
						value: 0
					}
				],

				// 开始
				start: function () {
					var result;

					return result;
				},

				// 分配
				allot: function () {
					var that = this,
						place;

					// 布局创建
					this.places = this.lib.swipepad.create();

					// 绑定资源功能
					// nw.lib.growup.data

					// 布局数据初始化
					$.each(this.places, function(i, place){

						// 资源功能绑定
						place = that.lib.growup.bind(place);

						// 按钮功能绑定
						place = that.lib.expand.bind(place);

						// 扩展功能绑定
						place = that.placeMethod(place);

						// 位置点击事件初始化
						place.el.find('.growups-value').click(function(){
							if ( that.selected )
								that.move(that.selected, place);
						});
					});

					// 拥有者位置部署
					$.each(this.groups, function(i, user){

						// 随机获取一个空位置
						place = that.lib.swipepad.random();

						// 绑定指定给用户
						place = that.lib.swipepad.user(place, user)

						// 位置开始资源增长
						that.lib.growup.start(place.id);
					});

					// 位置按钮功能定义
					that.lib.expand.click(function(id, type){
						var place = that.places.$get(id)[0];

						// 位置升级
						if ( type == 'up' ) {
							place.motion.upgrade();
						}

						// 位置移动比例选择
						else {
							place.params.resource.confirm = parseInt(type) / 100;

							// 位置保存至操作选择状态
							that.selected = place;
						}
					});
				},

				// 移动，从一个位置移动到另一个位置
				move: function ( source, target ) {
					var number = parseInt(source.params.resource.value * source.params.resource.confirm);
						type = this.moveType(source, target, number);

					// 确保来源位置和目标位置都有
					if ( !source && !target )
						return;

					// 确保来源和目标不相同
					if ( source.id == target.id )
						return;

					// 确保来源移动值大于0
					if ( number <= 0 )
						return;

					console.log(type);

					// 执行移动
					this[type](source, target, number);
					// this.moveType(source, target, number)

					// 刷新位置资源
					this.lib.growup.start(target.id);
					this.lib.growup.start(source.id);
				},

				// 判断移动类型
				moveType: function ( source, target, number ) {
					var result;

					// 目标位置无拥有者
					if ( !target.params.user.uid ) {
						result = 'toNew';
					}

					// 迁移
					else if ( source.params.user.uid == target.params.user.uid ) {
						result = 'toShift';
					}

					// 推进
					else if ( source.params.user.uid != target.params.user.uid ) {

						// 进攻
						if ( target.params.resource.value > number ) {
							result = 'toAttack';
						}

						// 攻占
						else if ( target.params.resource.value < number ) {
							result = 'toGsvj';
						}

						// 同归
						else if ( target.params.resource.value == number ) {
							result = 'toCofinal';
						}
					}

					return result;
				},

				// 占领 
				toNew: function ( source, target, number ) {
					source.motion.detach(number);
					target.motion.station(number);
					target.motion.owner(source.params.user.uid);	// 新位置归属拥有者
				},

				// 迁移 
				toShift: function ( source, target, number ) {
					source.motion.detach(number);
					target.motion.station(number);
				},

				// 进攻
				toAttack: function ( source, target, number ) {
					source.motion.detach(number);
					target.motion.detach(number);
				},

				// 攻占
				toGsvj: function ( source, target, number ) {
					source.motion.detach(number);
					target.motion.detach(target.params.resource.value);
					target.motion.station(number - target.params.resource.value);
					target.motion.owner(source.params.user.uid);	// 更改拥有者
				},

				// 同归
				toCofinal: function ( source, target, number ) {
					source.motion.leave();
					target.motion.leave();
				},

				// 位置方法
				placeMethod: function ( place ) {
					var that = this;
					
					// 位置扩展方法
					$.extend(place.motion, {
						
						// 设置所有者
						owner: function ( uid ) {
							var user = that.groups.$get(uid)[0];

							// 设置位置归属拥有者
							if ( user )
								that.lib.swipepad.user(place, user);
						},

						// 撤离
						leave: function () {
							that.lib.growup.set(place.id, 0);
							that.lib.growup.end(place.id);
							that.lib.swipepad.quit(place.id);
						},

						// 派遣出去
						detach: function ( value ) {
							if ( place.params.resource.value <= value ) {
								place.motion.leave();
							}
							else {
								place.motion.subValue(value);
							}
						},

						// 驻扎进来
						station: function ( value ) {
							place.motion.addValue(value);
						},

						// 升级
						upgrade: function () {
							that.lib.expand.up(place.id, function(){
								$(place.el).find('.swipepad-name').html(place.params.resource.value);

								// 重置并生产资源
								that.lib.growup.start(place.id);
							});
						},

						// 设置资源
						value: function ( value ) {
							that.lib.growup.set(place.id, value);
						},

						// 添加资源
						addValue: function ( value ) {
							that.lib.growup.set(place.id, place.params.resource.value + value);
						},

						// 减少资源
						subValue: function ( value ) {
							that.lib.growup.set(place.id, place.params.resource.value - value);
						}
					});

					return place;
				}
			});



			nw = nWar;


















			/*












			var datas = [];

			var users = ['my', 'computer'];


			// 创建布局
			datas = swipepad.create();

			// 随机拥有者位置
			swipepad.owner({
				name: 'my',
				color: '#CF000D'
			});	

			// 随机拥有者位置
			swipepad.owner({
				name: 'computer',
				color: '#207de5'
			});	

			// 绑定所有已被拥有的元素，自增
			growup.bind(datas);

			// 绑定功能
			expand.bind(datas);

			// 绑定对应的点击事件
			expand.click(function(id, type){
				var data = datas.$get('id='+ id)[0];

				if ( type == 'up' ) {
					expand.up(id, function(){
						$(data.el).find('.swipepad-name').html(data.value);
						growup.start(id);
					});
				}
				else {
					data.confirm = parseInt(type) / 100;
				}

			});

			// 设置所有被占用的，自增初始化和开始
			$.each(datas, function(i, data){

				// 初始化全部
				data.number = 0;
				[data].$update(expand.rule[0]);

				// 移动
				data.el.find('.growups-value').click(function(){
					var move = datas.$get('confirm > 0')[0],
						number = 0;

					// 如果有确认的
					if ( move ) {
						number = parseInt(move.number * move.confirm);

						// 确保值大于0
						if ( number <= 0 )
							return;

						move.number -= number;

						// 占领无主
						if ( !data.remark ) {
							data.number += number;

							// 新增拥有者位置
							swipepad.owner({
								name: move.remark,
								color:  move.bg
							}, data.id);

							// 启动自增
							growup.start(data.id);
						}

						// 迁移
						else if ( data.remark == move.remark ) {
							data.number += number;

							// 启动自增
							growup.start(data.id);
						}

						// 推进
						else if ( data.remark != move.remark ) {

							// 被抵住
							if ( data.number > number ) {
								data.number -= number;

								// 启动自增
								growup.start(data.id);
							}

							// 被占有
							else if ( data.number < number ) {
								data.number = number - data.number;

								// 更改拥有者
								swipepad.owner({
									name: move.remark,
									color:  move.bg
								}, data.id);

								// 启动自增
								growup.start(data.id);
							}

							// 同归，无主
							else {
								growup.goto(data.id, 0);
								swipepad.quit(data.id);
								growup.end(data.id);
							}

						}

						// move.number -= number;
						// data.number += number;

						// 新增拥有者位置
						// swipepad.owner({
						// 	name: move.remark,
						// 	color:  move.bg
						// }, data.id);

						// 全部移动
						if ( move.confirm == 1 ) {
							growup.goto(move.id, 0);
							swipepad.quit(move.id);
							growup.end(move.id);
						}
						else{
							growup.start(move.id);
						}

						// 恢复
						move.confirm = 0;
					}
				});
			});

			// 设置所有被占用的，自增初始化和开始
			$.each(datas.$get('remark!='), function(i, data){
				data.number = 0;
				growup.start(data.id);
			});
			

			*/


		</script>
	</body>
</html>